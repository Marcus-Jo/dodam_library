<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 모든 SQL문을 mapper태그 안에 작성 -->
<mapper namespace="searchMapper">
	
	<!-- resultmap 작성 -->
	<resultMap type="com.potato.project.common.vo.BookCateVO" id="cate">
		<id column="KDC_NUM" 			property="kdcNum"/>
		<result column="KDC_NAME" 		property="kdcName"/>
		<collection property="bookList" resultMap="book"/>
	</resultMap>
		
	<resultMap type="com.potato.project.common.vo.BookVO" id="book">
		<id column="BOOK_CODE" 			property="bookCode"/>
		<result column="ISBN" 			property="isbn"/>
		<result column="KDC" 			property="kdc"/>
		<result column="KDC_NUM" 		property="kdcNum"/>
		<result column="WRITER" 		property="writer"/>
		<result column="TITLE" 			property="title"/>
		<result column="PAGE" 			property="page"/>
		<result column="BOOK_SIZE" 		property="bookSize"/>
		<result column="KEYWORD" 		property="keyword"/>
		<result column="PUBLISHER" 		property="publisher"/>
		<result column="PUB_DATE" 		property="pubDate"/>
		<result column="SUMMARY" 		property="summary"/>
		<result column="INTRO" 			property="intro"/>
		<result column="INPUT_DATE" 	property="inputDate"/>
		<result column="AREA" 			property="area"/>
		<result column="STATUS" 		property="status"/>
		<collection property="bookImgVO" resultMap="bookImg"/>
	</resultMap>
	
	<resultMap type="com.potato.project.common.vo.BookImgVO" id="bookImg">
		<id column="IMG_CODE" 				property="imgCode"/>
		<result column="ORIGIN_IMG_NAME" 	property="originImgName"/>
		<result column="ATTACHED_IMG_NAME" 	property="attachedImgName"/>
		<result column="BOOK_CODE" 			property="bookCode"/>	
	</resultMap>
	
	<resultMap type="com.potato.project.common.vo.RentalVO" id="rental">
		<id column="RENTAL_CODE" 		property="rentalCode"/>
		<result column="ID" 			property="id"/>
		<result column="BOOK_CODE" 		property="bookCode"/>
		<result column="RENTAL_DATE" 	property="rentalDate"/>	
		<result column="RETURN_DATE" 	property="returnDate"/>	
		<result column="LIMIT_DATE" 	property="limitDate"/>	
	</resultMap>
	
	<resultMap type="com.potato.project.common.vo.ReserveVO" id="reserve">
		<id column="RESERVE_CODE" 				property="reserveCode"/>
		<result column="ID" 					property="id"/>
		<result column="BOOK_CODE" 				property="bookCode"/>
		<result column="RENTABLE_START_DATE" 	property="rentableStartDate"/>	
		<result column="RENTABLE_END_DATE" 		property="rentableEndDate"/>	
	</resultMap>

	<!-- 책 등록 -->
	<insert id="insertBook">
		INSERT INTO BOOK (
		    ISBN
		    , BOOK_CODE
		    , KDC
		    , KDC_NUM
		    , WRITER
		    , TITLE
		    , PAGE
		    , BOOK_SIZE
		    , KEYWORD
		    , PUBLISHER
		    , PUB_DATE
		    , SUMMARY
		    , INTRO
		    , AREA
		) VALUES (
		    #{isbn}
		    , (SELECT 'BOOK_'||LPAD(NVL(MAX(TO_NUMBER(SUBSTR(BOOK_CODE,6,4))),0) + 1,4,0) FROM BOOK)
		    , #{kdc}
		    , SUBSTR(#{kdc},1,1)
		    , #{writer}
		    , #{title}
		    , #{page}
		    , #{bookSize}
		    , #{keyword}
		    , #{publisher}
		    , #{pubDate}
		    , #{summary}
		    , #{intro}
			, #{area}
		)
	</insert>
	
	<!-- 모든 도서(+ 이미지) 조회 -->
	<select id="selectBookList" resultMap="book">
		SELECT
		    ISBN
		    , B.BOOK_CODE
		    , KDC
		    , B.KDC_NUM
		    , WRITER
		    , TITLE
		    , PAGE
		    , BOOK_SIZE
		    , KEYWORD
		    , PUBLISHER
		    , PUB_DATE
		    , SUMMARY
		    , INTRO
		    , INPUT_DATE
		    , AREA
		    , STATUS
		    , ATTACHED_IMG_NAME
		FROM BOOK B, BOOK_CATE C, BOOK_IMG I
		WHERE B.KDC_NUM = C.KDC_NUM
		AND B.BOOK_CODE = I.BOOK_CODE
		ORDER BY INPUT_DATE DESC
	</select>
	
	<!-- 책 카테고리 목록 조회 -->
	<select id="selectCateList" resultMap="cate">
		SELECT
			KDC_NUM
			, KDC_NAME
		FROM BOOK_CATE
	</select>
	
	<!-- 상태별 도서 조회 -->
	<select id="selectStatusBookList" resultMap="book">
		SELECT
		    ISBN
		    , B.BOOK_CODE
		    , KDC
		    , B.KDC_NUM
		    , WRITER
		    , TITLE
		    , PAGE
		    , BOOK_SIZE
		    , KEYWORD
		    , PUBLISHER
		    , PUB_DATE
		    , SUMMARY
		    , INTRO
		    , INPUT_DATE
		    , AREA
		    , STATUS
		FROM BOOK B, BOOK_CATE C
		WHERE B.KDC_NUM = C.KDC_NUM
		<if test="status != 0">
		AND STATUS = #{status}
		</if>
		ORDER BY INPUT_DATE DESC
	</select>	
	
	<!-- 상품 이미지 코드 숫자 생성 -->
	<select id="selectImgCodeNum" resultType="int">
		SELECT NVL(MAX(TO_NUMBER(SUBSTR(IMG_CODE,5,3))) + 1, 1) 
		FROM BOOK_IMG
	</select>
	
	<!-- 상품 이미지에 넣을 책 코드 생성 -->
	<select id="selectBookCode" resultType="String">
		SELECT 'BOOK_'||LPAD(NVL(MAX(TO_NUMBER(SUBSTR(BOOK_CODE,6,4))),0) + 1,4,0) 
		FROM BOOK
	</select>	
	
	<!-- 상품 이미지 등록 -->
	<insert id="insertBookImg">
		INSERT INTO BOOK_IMG (
		    IMG_CODE
		    , ORIGIN_IMG_NAME
		    , ATTACHED_IMG_NAME
		    , BOOK_CODE
		) VALUES (
		    #{bookImgVO.imgCode}
		    , #{bookImgVO.originImgName}
		    , #{bookImgVO.attachedImgName}
		    , #{bookImgVO.bookCode}
		)
	</insert>
	
	<!-- 도서 대여 & 도서 상태 변경 -->
	<insert id="insertRental">
		INSERT INTO RENTAL (
		    RENTAL_CODE
		    , ID
		    , BOOK_CODE
		) VALUES (
		    (SELECT 'RENTAL_'||LPAD(NVL(MAX(TO_NUMBER(SUBSTR(RENTAL_CODE,8,4))),0) + 1,4,0) FROM RENTAL)
		    , #{id}
		    , #{bookCode}
		)
	</insert>
	
	<!-- 도서 대여 & 도서 상태 변경 -->
	<update id="updateRentalStatus">
		UPDATE BOOK
		SET STATUS = 2
		WHERE BOOK_CODE = #{bookCode}
	</update>
	
	<!-- ID로 대여&예약 도서 객수 조회 -->
	<select id="selectIdAllCount" resultType="int">
		SELECT (SELECT COUNT(ID) FROM RENTAL WHERE ID = #{id})
		+ (SELECT COUNT(ID) FROM RESERVE WHERE ID = #{id}) AS COUNT_ID
		FROM DUAL	
	</select>
	
	<!-- ID로 회원여부 조회 -->
	<select id="selectIsMember" resultType="int">
		SELECT
		    COUNT(ID)
		FROM MEMBER
		WHERE ID = #{id}
	</select>
	
	
	<!-- 책 상세정보 조회 -->
	<select id="selectBookDetail" resultMap="book">
		SELECT
		    ISBN
		    , B.BOOK_CODE
		    , KDC
		    , B.KDC_NUM
		    , WRITER
		    , TITLE
		    , PAGE
		    , BOOK_SIZE
		    , KEYWORD
		    , PUBLISHER
		    , PUB_DATE
		    , SUMMARY
		    , INTRO
		    , INPUT_DATE
		    , AREA
		    , STATUS
		    , ATTACHED_IMG_NAME
		FROM BOOK B, BOOK_CATE C, BOOK_IMG I
		WHERE B.KDC_NUM = C.KDC_NUM
		AND B.BOOK_CODE = I.BOOK_CODE
		AND B.BOOK_CODE = #{bookCode}
	</select>
	
</mapper>












